@using Veb_Projekat.Models
@using Veb_Projekat.Models.Enums
@{
    ViewBag.Title = "My Reservations";
    var reservations = ViewBag.Reservations as List<Reservation>;
}

<h2 style="margin-left:10px;">My Reservations</h2>

<form class="filter-form" method="get" action="@Url.Action("MyReservations", "Tourist")" style="margin:20px auto;" >
    <div class="filters-row">
        <div>
            <label>Search (ID or Arrangement):</label>
            <input type="text" name="search" value="@ViewBag.Search" />
        </div>

        <div>
            <label>Status:</label>
            <select name="status">
                <option value="">All statuses</option>
                <option value="Active" @(ViewBag.Status == "Active" ? "selected" : "")>Active</option>
                <option value="Cancelled" @(ViewBag.Status == "Cancelled" ? "selected" : "")>Cancelled</option>
            </select>
        </div>

        <div>
            <label>Sort by:</label>
            <select name="sortBy">
                <option value="">None</option>
                <option value="ArrangementName" @(ViewBag.SortBy == "ArrangementName" ? "selected" : "")>Arrangement Name</option>
            </select>
        </div>
        <div>
            <label>Order:</label>
            <select name="sortDir">
                <option value="asc" @(ViewBag.SortDir == "asc" ? "selected" : "")>Ascending</option>
                <option value="desc" @(ViewBag.SortDir == "desc" ? "selected" : "")>Descending</option>
            </select>
        </div>

        <div>
        </div>
        <div class="btn-container">
            <button type="submit">Apply Filters</button>
            <a href="@Url.Action("MyReservations", "Tourist")" style="margin-left:10px;">Clear Filters</a>
        </div>
        
    </div>
</form>

@if (reservations != null && reservations.Any())
{
    <div style="margin:20px;">

        <table border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse:collapse;">
            <thead style="background:#e9ecef;">
                <tr>
                    <th>Reservation ID</th>
                    <th>Arrangement</th>
                    <th>Location</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Unit Price</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in reservations)
                {
                    bool isPast = r.SelectedArrangement.StartDate <= DateTime.Now;
                    bool canCancel = r.Status == ReservationStatusEnum.Active && !isPast;
                    bool canComment = r.Status == ReservationStatusEnum.Active && r.SelectedArrangement.EndDate < DateTime.Now;

                    <tr style="background:@(r.Status == ReservationStatusEnum.Cancelled ? "#f8d7da" : (isPast ? "#fff3cd" : "#d4edda"));">
                        <td>@r.Id.ToString().Substring(0, 8)...</td>
                        <td><strong>@r.SelectedArrangement.Name</strong></td>
                        <td>@r.SelectedArrangement.Location</td>
                        <td>@r.SelectedArrangement.StartDate.ToString("dd/MM/yyyy")</td>
                        <td>@r.SelectedArrangement.EndDate.ToString("dd/MM/yyyy")</td>
                        <td>@r.SelectedUnit.Price.ToString("C")</td>
                        <td>
                            <span style="padding:3px 8px; border-radius:3px; color:white; background:@(r.Status == ReservationStatusEnum.Active ? "#28a745" : "#dc3545");">
                                @r.Status
                            </span>
                            <small style="margin-left:5px; color:#6c757d;">(@(isPast ? "Past" : "Upcoming"))</small>
                        </td>
                        <td style="padding: 10px;">
                            @Html.ActionLink("Details", "ReservationDetails", new { reservationId = r.Id }, new { @style = "margin-right:5px;" })

                            @if (canCancel)
                            {
                                using (Html.BeginForm("CancelReservation", "Tourist", FormMethod.Post, new { @class = "button-form", @style = "display:inline;" }))
                                {
                                    <input type="hidden" name="reservationId" value="@r.Id" />
                                    <button type="submit" onclick="return confirm('Are you sure you want to cancel this reservation?');"
                                            style="background:#dc3545; color:white; border:none; padding:3px 8px; cursor:pointer;">
                                        Cancel
                                    </button>
                                }
                            }

                            @if (canComment)
                            {

                                var accommodationForComment = r.SelectedArrangement.Accommodations
                                       .FirstOrDefault(a => a.Units.Any(u => u.Id == r.SelectedUnit.Id));


                                if (accommodationForComment != null)
                                {
                                    @Html.ActionLink("Leave Comment", "LeaveComment", new { accommodationId = accommodationForComment.Id, reservationId = r.Id.ToString() },
                                                   new { @style = "margin-left:5px; background:#17a2b8; color:white; padding:3px 8px; text-decoration:none; border-radius:6px;" })
                                }
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>

    </div>

    <p style="margin-top:15px;">
        <strong>Total reservations:</strong> @reservations.Count |
        <strong>Active:</strong> @reservations.Count(r => r.Status == ReservationStatusEnum.Active) |
        <strong>Cancelled:</strong> @reservations.Count(r => r.Status == ReservationStatusEnum.Cancelled)
    </p>
}
else
{
    <div style="background:#d1ecf1; color:#0c5460; padding:15px; border:1px solid #bee5eb; border-radius:5px;">
        <h4>No reservations found</h4>
        <p>You haven't made any reservations yet or no reservations match your current filters.</p>
        <p>@Html.ActionLink("Browse Arrangements", "Index", "Home", null, new { @class = "btn", @style = "background:#007bff; color:white; padding:8px 15px; text-decoration:none; border-radius:3px;" })</p>
    </div>
}