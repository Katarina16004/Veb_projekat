<html>
<head>
    <title>Arrangements</title>
</head>
<body>
    @using Veb_Projekat.Models
    @{
        ViewBag.Title = "Arrangements";
        var arrangements = ViewBag.Arrangements as List<Arrangement>;
    }

    <div class="container">
        <h2>Search Arrangements</h2>

        <form method="get" action="@Url.Action("Index", "Home")">
            <div class="filters-row">
                <div>
                    <label>Name:</label>
                    <input type="text" name="name" value="@ViewBag.SelectedName" />
                </div>
                <div>
                    <label>Location:</label>
                    <input type="text" name="location" value="@ViewBag.SelectedLocation" />
                </div>
                <div>
                    <label>Type:</label>
                    <select name="type">
                        <option value="">All types</option>
                        @foreach (var t in ViewBag.ArrangementTypes)
                        {
                            <option value="@t" @(ViewBag.SelectedType == t.ToString() ? "selected" : "")>@t</option>
                        }
                    </select>
                </div>
                <div>
                    <label>Transport:</label>
                    <select name="transport">
                        <option value="">All transport</option>
                        @foreach (var t in ViewBag.TransportTypes)
                        {
                            <option value="@t" @(ViewBag.SelectedTransport == t.ToString() ? "selected" : "")>@t</option>
                        }
                    </select>
                </div>
                <div>
                    <label>Start date from:</label>
                    <input type="date" id="startDateFrom" name="startDateFrom" value="@ViewBag.SelectedStartFrom" />
                    <label>to:</label>
                    <input type="date" id="startDateTo" name="startDateTo" value="@ViewBag.SelectedStartTo" />
                </div>
                <div>
                    <label>End date from:</label>
                    <input type="date" id="endDateFrom" name="endDateFrom" value="@ViewBag.SelectedEndFrom" />
                    <label>to:</label>
                    <input type="date" id="endDateTo" name="endDateTo" value="@ViewBag.SelectedEndTo" />
                </div>
                <div>
                    <label>Sort by:</label>
                    <select name="sortBy">
                        <option value="">None</option>
                        <option value="Name" @(ViewBag.SortBy == "Name" ? "selected" : "")>Name</option>
                        <option value="StartDate" @(ViewBag.SortBy == "StartDate" ? "selected" : "")>Start Date</option>
                        <option value="EndDate" @(ViewBag.SortBy == "EndDate" ? "selected" : "")>End Date</option>
                    </select>
                    <select name="sortDir">
                        <option value="asc" @(ViewBag.SortDir == "asc" ? "selected" : "")>Ascending</option>
                        <option value="desc" @(ViewBag.SortDir == "desc" ? "selected" : "")>Descending</option>
                    </select>
                </div>
            </div>

            <div class="btn-container">
                <button type="submit">Apply</button>
                <a href="@Url.Action("Index", "Home")">Reset</a>
            </div>
        </form>

        <hr />

        <h3>Results:</h3>

        @if (arrangements != null && arrangements.Any())
        {
            <div class="section arrangement">
                <table>
                    <thead>
                        <tr>
                            <th>Poster</th>
                            <th>Name</th>
                            <th>Location</th>
                            <th>Type</th>
                            <th>Transport</th>
                            <th>Start Date <br /> (mm/dd/yyyy)</th>
                            <th>End Date <br /> (mm/dd/yyyy)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var a in arrangements)
                        {
                            <tr>
                                <td>
                                    @{
                                        if (!string.IsNullOrEmpty(a.Poster))
                                        {
                                            var serverPath = Server.MapPath("~/App_Data/Images/" + a.Poster);
                                            if (System.IO.File.Exists(serverPath))
                                            {
                                                <img src="@Url.Action("GetImage", "Home", new { fileName = a.Poster })"
                                                     alt="Poster" style="width:100px; height:auto;" />
                                            }
                                            else
                                            {
                                                <span>Not found</span>
                                            }
                                        }
                                        else
                                        {
                                            <span>Not found</span>
                                        }
                                    }
                                </td>
                                <td>@a.Name</td>
                                <td>@a.Location</td>
                                <td>@a.Type</td>
                                <td>@a.Transport</td>
                                <td>@a.StartDate.ToString("MM/dd/yyyy", System.Globalization.CultureInfo.InvariantCulture)</td>
                                <td>@a.EndDate.ToString("MM/dd/yyyy", System.Globalization.CultureInfo.InvariantCulture)</td>
                                <td>
                                    @Html.ActionLink("Details", "Details", new { id = a.Id })
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p class="no-accommodations">No arrangements found.</p>
        }
    </div>

    @section scripts {
        <script>
            const startFrom = document.getElementById('startDateFrom');
            const startTo = document.getElementById('startDateTo');
            const endFrom = document.getElementById('endDateFrom');
            const endTo = document.getElementById('endDateTo');

            function updateDateLimits() {
                startTo.min = startFrom.value;
                endFrom.min = startFrom.value;
                endTo.min = endFrom.value;
            }

            startFrom.addEventListener('change', updateDateLimits);
            startTo.addEventListener('change', updateDateLimits);
            endFrom.addEventListener('change', updateDateLimits);
            endTo.addEventListener('change', updateDateLimits);

            updateDateLimits();
        </script>
    }
</body>
</html>
