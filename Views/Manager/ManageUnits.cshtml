@using Veb_Projekat.Models
@{
    ViewBag.Title = "Manage Units";
    var accommodation = ViewBag.Accommodation as Accommodation;
    var units = ViewBag.Units as List<AccommodationUnit>;
}

<h2>Manage Units for: @accommodation.Name</h2>

<p><strong>Accommodation Details:</strong></p>
<ul>
    <li>Type: @accommodation.Type</li>
    <li>Stars: @(accommodation.Type == Veb_Projekat.Models.Enums.AccommodationTypeEnum.Hotel ? accommodation.Stars.ToString() : "N/A")</li>
    <li>
        Features:
        @if (accommodation.HasPool)
        {<span>Pool</span>}
        @if (accommodation.HasSpa)
        {<span>Spa</span>}
        @if (accommodation.Accessible)
        {<span>Accessible</span>}
        @if (accommodation.HasWifi)
        {<span>WiFi</span>}
    </li>
</ul>

@if (TempData["Success"] != null)
{
    <p style="color: green;"><strong>Success:</strong> @TempData["Success"]</p>
}

@if (TempData["Error"] != null)
{
    <p style="color: red;"><strong>Error:</strong> @TempData["Error"]</p>
}

<h3>Actions</h3>
<p>
    @Html.ActionLink("Add New Unit", "CreateUnit", new { accommodationId = accommodation.Id }, new { @class = "btn" }) |
    @Html.ActionLink("Back to Accommodations", "ManageAccommodations", new { arrangementId = Request.QueryString["arrangementId"] }) |
    @Html.ActionLink("Back to Dashboard", "Index")
</p>

<h3>Units (@(units?.Count ?? 0))</h3>

@if (units != null && units.Any())
{
    <table border="1" style="width: 100%; border-collapse: collapse;">
        <tr style="background-color: #f0f0f0;">
            <th style="padding: 10px;">Unit ID</th>
            <th style="padding: 10px;">Max Guests</th>
            <th style="padding: 10px;">Pets Allowed</th>
            <th style="padding: 10px;">Price per Night</th>
            <th style="padding: 10px;">Status</th>
            <th style="padding: 10px;">Reservations</th>
            <th style="padding: 10px;">Actions</th>
        </tr>

        @foreach (var unit in units)
        {
            // da li ima aktivne rezervacije
            var reservations = Veb_Projekat.Repositories.ReservationRepository.GetAll()
                .Where(r => r.SelectedUnit.Id == unit.Id &&
                           r.Status == Veb_Projekat.Models.Enums.ReservationStatusEnum.Active)
                .ToList();

            var futureReservations = reservations
                .Where(r => r.SelectedArrangement.StartDate > DateTime.Now)
                .ToList();

            <tr style="@(unit.IsDeleted ? "background-color: #ffeeee;" : "")">
                <td style="padding: 10px;">
                    <strong>Unit #@unit.Id</strong>
                    @if (unit.IsDeleted)
                    {
                        <br /><span style="color: red;">(DELETED)</span>
                    }
                </td>
                <td style="padding: 10px;">
                    @unit.MaxGuests @(unit.MaxGuests == 1 ? "guest" : "guests")
                </td>
                <td style="padding: 10px;">
                    @if (unit.PetsAllowed)
                    {
                        <span style="color: green;">Yes</span>
                    }
                    else
                    {
                        <span style="color: red;">No</span>
                    }
                </td>
                <td style="padding: 10px;">
                    @unit.Price.ToString("F2") RSD
                </td>
                <td style="padding: 10px;">
                    <span style="color: @(unit.IsDeleted ? "red" : "green");">
                        @(unit.IsDeleted ? "Deleted" : "Active")
                    </span>
                </td>
                <td style="padding: 10px;">
                    @if (reservations.Any())
                    {
                        <span style="color: orange;">@reservations.Count active</span>
                        if (futureReservations.Any())
                        {
                            <br /><small style="color: red;">@futureReservations.Count future</small>
                        }
                    }
                    else
                    {
                        <span style="color: green;">Available</span>
                    }
                </td>
                <td style="padding: 10px;">
                    @Html.ActionLink("Edit", "EditUnit", new { id = unit.Id })

                    @if (!unit.IsDeleted)
                    {
                        @Html.Raw(" | ")
                        using (Html.BeginForm("DeleteUnit", "Manager", FormMethod.Post, new { style = "display:inline;" }))
                        {
                            <input type="hidden" name="id" value="@unit.Id" />
                            <input type="submit" value="Delete" onclick="return confirm('Are you sure you want to delete this unit?');"
                                   style="background-color: #ff4444; color: white; border: none; padding: 2px 8px;" />
                        }
                    }
                </td>
            </tr>
        }
    </table>
}
else
{
    <p>No units yet. @Html.ActionLink("Add the first one", "CreateUnit", new { accommodationId = accommodation.Id })!</p>
}