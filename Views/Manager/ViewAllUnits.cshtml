@using Veb_Projekat.Models
@{
    ViewBag.Title = "All My Units";
    var units = ViewBag.MyUnits as List<AccommodationUnit>;
}

<h2>All My Units</h2>

@if (TempData["Success"] != null)
{
    <p style="color: green;"><strong>Success:</strong> @TempData["Success"]</p>
}

@if (TempData["Error"] != null)
{
    <p style="color: red;"><strong>Error:</strong> @TempData["Error"]</p>
}

<h3>Statistics</h3>
<ul>
    <li>Total Units: @((int)ViewBag.TotalUnits)</li>
    <li>Active: @((int)ViewBag.ActiveUnits)</li>
    <li>Deleted: @((int)ViewBag.DeletedUnits)</li>
</ul>

<p>
    @Html.ActionLink("Back to Dashboard", "Index") |
    @Html.ActionLink("View Accommodations", "ViewAllAccommodations") |
    @Html.ActionLink("View Arrangements", "ViewAllArrangements")
</p>

@if (units != null && units.Any())
{
    <table border="1" style="width: 100%; border-collapse: collapse;">
        <tr style="background-color: #f0f0f0;">
            <th style="padding: 10px;">Unit</th>
            <th style="padding: 10px;">Capacity</th>
            <th style="padding: 10px;">Pets</th>
            <th style="padding: 10px;">Price</th>
            <th style="padding: 10px;">Status</th>
            <th style="padding: 10px;">Reservations</th>
            <th style="padding: 10px;">Parent Accommodation</th>
            <th style="padding: 10px;">Actions</th>
        </tr>

        @foreach (var unit in units)
        {
            var allGrouped = Veb_Projekat.Repositories.AccommodationUnitRepository.GetAllGrouped();
            int accommodationId = -1;

            foreach (var kvp in allGrouped)
            {
                if (kvp.Value.Any(u => u.Id == unit.Id))
                {
                    accommodationId = kvp.Key;
                    break;
                }
            }

            var parentAccommodation = Veb_Projekat.Repositories.AccommodationRepository.GetById(accommodationId);

            // rezervacije
            var reservations = Veb_Projekat.Repositories.ReservationRepository.GetAll()
                .Where(r => r.SelectedUnit.Id == unit.Id &&
                           r.Status == Veb_Projekat.Models.Enums.ReservationStatusEnum.Active)
                .ToList();

            var futureReservations = reservations
                .Where(r => r.SelectedArrangement.StartDate > DateTime.Now)
                .ToList();

            <tr style="@(unit.IsDeleted ? "background-color: #ffeeee;" : "")">
                <td style="padding: 10px;">
                    <strong>Unit #@unit.Id</strong>
                    @if (unit.IsDeleted)
                    {
                        <br /><span style="color: red;">(DELETED)</span>
                    }
                </td>
                <td style="padding: 10px;">
                    @unit.MaxGuests @(unit.MaxGuests == 1 ? "guest" : "guests")
                </td>
                <td style="padding: 10px;">
                    @if (unit.PetsAllowed)
                    {
                        <span style="color: green;">Yes</span>
                    }
                    else
                    {
                        <span style="color: red;">No</span>
                    }
                </td>
                <td style="padding: 10px;">
                    @unit.Price.ToString("F2") RSD
                </td>
                <td style="padding: 10px;">
                    <span style="color: @(unit.IsDeleted ? "red" : "green");">
                        @(unit.IsDeleted ? "Deleted" : "Active")
                    </span>
                </td>
                <td style="padding: 10px;">
                    @if (reservations.Any())
                    {
                        <span style="color: orange;">@reservations.Count active</span>
                        if (futureReservations.Any())
                        {
                            <br /><small style="color: red;">@futureReservations.Count future</small>
                        }
                    }
                    else
                    {
                        <span style="color: green;">Available</span>
                    }
                </td>
                <td style="padding: 10px;">
                    @if (parentAccommodation != null)
                    {
                        @Html.ActionLink(parentAccommodation.Name, "ManageUnits", new { accommodationId = parentAccommodation.Id })
                        <br /><small>@parentAccommodation.Type</small>
                    }
                    else
                    {
                        <span style="color: gray;">Unknown</span>
                    }
                </td>
                <td style="padding: 10px;">
                    @Html.ActionLink("Edit", "EditUnit", new { id = unit.Id })

                    @if (!unit.IsDeleted && parentAccommodation != null)
                    {
                        @Html.Raw(" | ")
                        @Html.ActionLink("Manage", "ManageUnits", new { accommodationId = parentAccommodation.Id })
                        @Html.Raw(" | ")

                        using (Html.BeginForm("DeleteUnit", "Manager", FormMethod.Post, new { style = "display:inline;" }))
                        {
                            <input type="hidden" name="id" value="@unit.Id" />
                            <input type="submit" value="Delete" onclick="return confirm('Are you sure you want to delete this unit?');"
                                   style="background-color: #ff4444; color: white; border: none; padding: 2px 8px;" />
                        }
                    }
                </td>
            </tr>
        }
    </table>
}
else
{
    <p>No units found. Start by @Html.ActionLink("creating some accommodations", "ViewAllAccommodations") first!</p>
}